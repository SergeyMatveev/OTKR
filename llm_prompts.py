SYSTEM_PROMPT_STAGE2 = """
PROMPT_BEGIN

Задача: извлечь из одного кредитного блока (Markdown) значения полей и вернуть ответ СТРОГО фиксированным форматом.

ВХОД
• Один кредитный блок в Markdown (как есть).

ОБЩИЕ ПРАВИЛА
• Данные брать ТОЛЬКО из входного блока. Ничего не придумывать.
• Текст не “улучшать” и не интерпретировать. Разрешено ТОЛЬКО:
  – склеивать переносы слов/строк (когда слово/значение разорвано переносом).
• Если значение поля не найдено — ставить ровно «Н/Д» (кириллица, заглавные Н и Д, слэш /).
• Любые OCR-варианты «H/Д», «Н/д», «н/д», «H/Д» и т.п. приводить к «Н/Д».

ОПРЕДЕЛЕНИЯ
• "Блок" = весь входной текст.
• "Строка" = строка текста в блоке.
• "Склейка переносов" = удаление перевода строки внутри одного разорванного значения/слова (например: "№ЭК\n1290856" → "№ЭК1290856").
• "Кандидат" = фрагмент текста, потенциально являющийся значением поля.

АЛГОРИТМ (ОБЩИЙ)
1) Подготовка текста:
   • Выполнить только склейку переносов слов/значений там, где очевидно разорвано одно значение.
   • Остальной текст не менять.

2) Извлечь поле «Прекращение обязательства»:
   • Допустимы ТОЛЬКО 4 значения:
     – «Н/Д»
     – «Надлежащее исполнение обязательства»
     – «Прощение долга»
     – «Иное основание»
   • Если в блоке встречается фраза «Надлежащее исполнение обязательства» (в точности) → вернуть её.
   • ИНАЧЕ если в блоке встречается фраза «Прощение долга» (в точности) → вернуть её.
   • ИНАЧЕ если в блоке встречается фраза «Иное основание» (в точности) → вернуть её.
   • ИНАЧЕ → вернуть «Н/Д».

3) Извлечь поле «Дата сделки»:
   • Ищи значение рядом с метками (регистр не важен): «Дата сделки».
   • Если найдено — вернуть дату ровно как в тексте (после склейки переносов, если была).
   • Если не найдено — вернуть «Н/Д».

4) Извлечь поле «Сумма и валюта»:
   • Ищи сумму рядом с метками (регистр не важен): «Сумма», «Сумма сделки», «Сумма и валюта».
   • Если меток нет — ищи денежное значение по признакам:
     – содержит цифры
     – может содержать пробелы-разделители тысяч
     – может содержать запятую для копеек
   • Кандидат на сумму возвращай КАК В ТЕКСТЕ (не удалять пробелы, не менять запятую/точку).
   • В ответе валюта должна быть «RUB», но:
     – если сумма не найдена → значение поля строго «Н/Д».
     – если сумма найдена → выводить: «<сумма> RUB».

5) Извлечь поле «УИд договора» (строго по правилам):
   • Ищи метки: «УИд договора», «УИД договора», «Уид договора».
   • Кандидат нормализуй:
     – убери пробелы и переводы строк
     – все тире замени на «-»
     – латиницу сделай строчной
   • Допустимые OCR-подстановки при проверке: O↔0, I↔1, l↔1, S↔5, Z↔2, B↔8.
   • В первых 5 группах разрешены только [0-9a-f], кириллица запрещена.
   • Формат обязателен: 8-4-4-4-12-1 (пример: c456294b-dcd0-11aa-81b3-efa2ccd7b24f-7).
   • Можно восстановить ТОЛЬКО пропущенные дефисы по схеме 8-4-4-4-12-1, символы не придумывать.
   • Если валидного идентификатора нет — вернуть «Не найдено».

6) Извлечь поле «Номер договора»:
   • Цель: найти номер договора, если он присутствует в блоке, без “угадываний”.
   • Правило поиска:
     A) Если есть фрагменты со словами (регистр не важен): «Номер договора»
        – возьми значение после маркера (или после слов «Номер договора» если сразу идёт номер) как кандидат.
   • Кандидат возвращай КАК В ТЕКСТЕ.
   • Ничего не придумывай и не “восстанавливай” символы.
   • Если не найдено — вернуть «Н/Д».

ФОРМАТ ОТВЕТА (СТРОГО)
• РОВНО 5 строк.
• Без кода, таблиц, JSON, списков и любой Markdown-разметки.
• Без лишних пробелов/строк/комментариев.
• Порядок строк строго такой:

Прекращение обязательства: …
Дата сделки: …
Сумма и валюта: …
УИд договора: …
Номер договора: …

ЗАПРЕТЫ
• Запрещено добавлять любые пояснения.
• Запрещено выводить больше или меньше 5 строк.
• Запрещено исправлять OCR-ошибки (кроме нормализации Н/Д и склейки переносов).
• Запрещено “догадываться” и дополнять отсутствующие данные.

PROMPT_END
""".strip()

PROMPT_STAGE5 = """
Ты получаешь ОДИН кредитный блок в формате Markdown (MD).
ТВОЯ ЗАДАЧА — вернуть РОВНО 2 СТРОКИ С ЖЁСТКИМИ ПРЕФИКСАМИ (без кода, без таблиц, без Markdown-разметки):

Приобретатель прав кредитора: ...
ИНН приобретателя прав кредитора: ...

Требования:
- Если поле отсутствует — пиши строго: Н/Д (кириллица, заглавные Н и Д, слэш /).
- В ИНН — РОВНО 10 ЦИФР (иначе Н/Д).
- НИКАКИХ дополнительных строк, пустых строк, комментариев, описаний, JSON и т.п.
- Если вернёшь без префиксов — ответ считается НЕВАЛИДНЫМ. Всегда пиши указанные префиксы в начале строк.
""".strip()

SYSTEM_PROMPT_INN_FALLBACK = """
Ты получаешь ОДИН кредитный блок целиком (Markdown-текст отчёта НБКИ).

НАЙДИ в нём ИНН организации — последовательность РОВНО из 10 цифр.

Требования к ответу:
- Ответь строго ОДНОЙ строкой.
- Если ИНН найден — верни ТОЛЬКО эти 10 цифр подряд, без пробелов, без комментариев, без дополнительных слов.
- Если ИНН нет или его нельзя однозначно определить по тексту — верни ровно: Н/Д (кириллица, заглавные Н и Д, слэш /).

Никаких JSON, описаний, пояснений, перевода строки или других символов, только одна строка по правилам выше.
""".strip()

SYSTEM_PROMPT_STAGE4 = """
[INSTRUCTIONS]
Задача: извлечь значение суммы срочной задолженности из текстового фрагмента таблицы НБКИ.

ОПРЕДЕЛЕНИЯ
"Строка" — строка таблицы, содержащая дату и числовые поля.
"Дата" — значение формата dd.mm.yyyy или dd-mm-yyyy.
"Колонка" — элемент строки, разделённый символом | (pipe).
"Ячейка" — текст между двумя соседними символами | в одной строке.
Правило ячеек: лидирующие и хвостовые пустые ячейки (из-за начального/конечного |) игнорировать.
"Разделительная строка Markdown" — строка вида "| --- | --- | ... |", состоящая только из символов |, -, :, пробелов. Такие строки игнорировать.
"Сумма" — значение в 3-й колонке строки после даты.
"Допустимая сумма" — строка, удовлетворяющая ЛЮБОМУ формату:
- целое число (пример: 32934)
- число с пробелами между разрядами (пример: 12 345, 1 234 567)
- число с копейками через запятую (пример: 32934,00, 12 345,67)
- любое из вышеперечисленных + валютный постфикс (RUB, руб, Rur), например: 22320,00 RUB, 12 000 руб
ВАЖНО: валютный постфикс считать частью значения. Ничего не удалять и не менять.

АЛГОРИТМ
Перед обработкой:
- игнорировать все "Разделительная строка Markdown".

1) Найти среди всех строк таблицы строку с самой поздней датой.
- сравнение выполнять календарно: год → месяц → день.
- если в таблице нет ни одной корректной даты: результат = Н/Д.
ВАЖНО: строка выбирается ТОЛЬКО по самой поздней дате. Наличие/отсутствие суммы НЕ влияет на выбор строки.

2) Для выбранной строки распарсить колонки:
- колонка 1 = дата
- колонка 2 = игнорировать
- колонка 3 = кандидат на сумму

3) Проверить колонку 3:
- если колонка 3 выглядит как "Дата" (dd.mm.yyyy или dd-mm-yyyy): результат = Н/Д
- если в колонке 3 нет ни одной цифры: результат = Н/Д
- если колонка 3 соответствует формату "Допустимая сумма": принять значение как есть
- запрещено модифицировать значение: не удалять пробелы, не менять регистр, не убирать валюту
- если колонка 3 существует, но НЕ соответствует "Допустимая сумма": результат = Н/Д
- если колонка 3 отсутствует: результат = Н/Д
- если извлечение суммы невозможно по любой причине: результат = Н/Д

ВНУТРЕННИЙ ЧЕК-ЛИСТ (НЕ ВЫВОДИТЬ)
Перед ответом внутренне проверь:
(1) выбрана максимальная дата календарно (YYYY→MM→DD);
(2) сумма взята строго из 3-й колонки этой же строки;
(3) если в 3-й колонке нет цифр — ответ Н/Д.
Если хоть один пункт не выполнен — ответ Н/Д.

ФОРМАТ ОТВЕТА (СТРОГО)
Вернуть только одну строку:
Срочная задолженность: <значение>

Где <значение>:
- либо точное исходное значение суммы (без изменений)
- либо Н/Д

ЗАПРЕТЫ
- запрещено добавлять пояснения
- запрещено выводить более одной строки
- запрещено исправлять OCR-ошибки
- запрещено интерпретировать неоднозначные форматы
- запрещено менять найденное значение
- запрещено выводить JSON, списки, комментарии
- ЗАПРЕЩЕНО брать значение суммы из любой другой строки, кроме строки с самой поздней датой
- ЗАПРЕЩЕНО "подбирать" последнюю числовую сумму, если в выбранной строке колонка 3 = Н/Д или невалидна
- если выбранная строка даёт Н/Д — результат обязан быть Н/Д

ВЫВОД
Вернуть только одну строку вида:
Срочная задолженность: <значение>
""".strip()
